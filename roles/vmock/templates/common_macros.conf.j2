# The following can be assumed to exist on the host.
# They are reproduced here to serve as a reference.

################################################################################################################
# Public access macro
<Macro access_all>
  <Location />
    Order Allow,Deny
    Allow from all
    Deny from env=badrobot
  </Location>
</Macro>


################################################################################################################
# Access whitelist macro
<Macro access_whitelist>
  <Location />
    Order Deny,Allow
    Deny from all
    {% for ip in apache_whitelisted_ips %}
    Allow from {{ ip }}
    {% endfor %}
  </Location>
</Macro>


################################################################################################################
# Macro to assign logging options
# $instance is the instance name, e.g. "production" or "staging"  ????
<Macro logging $instance>
    ErrorLog              "| /usr/bin/rotatelogs ${APACHE_LOG_DIR}/$instance/error_log-%Y%m%d 86400 -300" 
    CustomLog             "| /usr/bin/rotatelogs ${APACHE_LOG_DIR}/$instance/access_log-%Y%m%d 86400 -300" combined
</Macro>


################################################################################################################
# Common CoSign options
<Macro cosign_common $cosign_service $ssl_key $ssl_crt>
  CosignProtected               On
  CosignHostname                weblogin.umich.edu
  CosignValidReference          ^https?:\/\/[^/]+.umich\.edu(\/.*)?
  CosignValidationErrorRedirect http://weblogin.umich.edu/cosign/validation_error.html
  CosignCheckIP               never
  CosignRedirect              https://weblogin.umich.edu/
  CosignNoAppendRedirectPort  On
  CosignPostErrorRedirect     https://weblogin.umich.edu/post_error.html
  CosignService               $cosign_service
  CosignCrypto                /etc/ssl/private/$ssl_key /etc/ssl/certs/$ssl_crt /etc/ssl/certs
  
  <Location /cosign/valid>
    SetHandler cosign
    CosignProtected Off
    Allow from all
    Satisfy any
  </Location>
  
  <Location /robots.txt>
    CosignProtected Off
    Allow from all
    Satisfy any
  </Location>
  
  # Do not rewrite cosign session initiation.
  RewriteEngine On
  RewriteCond   %{REQUEST_URI}  !^/cosign/valid
</Macro>
???? ansible breaks when you attempt to use an undefined variable, so we would need to
????  only insert this if e.g. apache_uses_cosign=yes
???? The above macro is common to all sites, at least on nectar.


